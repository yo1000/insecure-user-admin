# INSECURE USER ADMIN
セキュアプログラミングの初学者向けに教材として作成した、  
脆弱なユーザー管理システムです。

重要なデータは、ぜったいに このシステムでは扱わないでください。


## How to start

```
$ git clone https://github.com/yo1000/insecure-user-admin.git
$ cd insecure-user-admin
$ ./mvnw spring-boot:run
```

ブラウザで URL にアクセスします。  
[http://localhost:8080/](http://localhost:8080/)

もし、`8080` ポートが空いていない場合、  
起動コマンドを、以下の様に変更して試してみてください。

```
$ ./mvnw spring-boot:run -Dserver.port=18080
```

アプリケーションが、`18080` ポートで起動するので、  
改めて以下の URL にアクセスします。  
[http://localhost:18080/](http://localhost:18080/)

## Exercise
初学者向けなので、あくまで簡単な例のみの提示となります。  
ここでの紹介だけを鵜呑みにすることなく、  
自ら調べて、適切な対策を施すようにしましょう。

### Step1
入力を工夫し、エラーを誘発して、実行される SQL を調べてみましょう。

#### Answer
[ユーザー名] に `'` を入力して、[サインイン] します。

例外が適切に処理されていないため、エラーの発生した SQL が画面に表示されてしまいます。

### Step2
調べた SQL をもとに、不正ログインしてみましょう。

#### Answer
[パスワード] に `' OR ''='` を入力して、[サインイン] します。

SQL がプレースホルダーにより組み立てられておらず、  
単純な文字列連結により行われているため、  
ユーザー抽出条件の末尾に、`OR ''=''` ができてしまい、  
[ユーザー名]、[パスワード] が分からずとも、ユーザーが抽出され、  
ログインできたものとみなされてしまいます。

### Step3
ログインしたユーザー管理システムで、パスワードを不正に入手しましょう。

#### Answer
[プロファイル変更] 画面で、[フルネーム] に以下を入力して、[更新] します。  
`', username=password --`

または、ユーザー名をそのまま維持したい場合は、以下のようにします。  
`' || (SELECT password FROM user WHERE username='YAGAMI') || ' ' || (SELECT password FROM user WHERE username='AMANE') || ' ' || (SELECT password FROM user WHERE username='MATSUDA') || ' ' || (SELECT password FROM user WHERE username='MOGI') || ' ' || (SELECT password FROM user WHERE username='AIZAWA') || ' ' || (SELECT password FROM user WHERE username='IDE') || ' ' || (SELECT password FROM user WHERE username='DEMEGAWA') || ' ' || (SELECT password FROM user WHERE username='TAKADA') || '`

SQL がプレースホルダーにより組み立てられておらず、  
単純な文字列連結により行われているため、  
`UPDATE {table name} SET {column name}=` の後に、  
他列の更新や、コメントアウト、サブクエリなどを埋め込むことができてしまい、  
[ユーザー名] をそのままパスワードで置き換えたり、  
[ユーザーリスト] 画面から確認することのできる [ユーザー名] を併せて利用することで、  
指定したユーザーの [パスワード] を、[フルネーム] に設定することができてしまいます。

### Step4
どのような対策をしておけば、このような不正を防止することが出来たか、考えてみましょう。

#### Answer
このシステムでは、さまざまな脆弱性が放置されています。  
これらをひとつずつ、適切に対応していくことで、不正を防止します。

今回の場合であれば、例えば、以下のような対策を行うべきでしょう。  

1. SQL インジェクション対策として、クエリの組み立てには必ずプレースホルダーを使用する。
2. パスワードを一方向ハッシュにかけ、平文を復元不可能な状態で保存する。
3. 例外を適切にハンドリングし、エラーの内容を画面に表示しないようにする。
4. 入力フィールドに入力可能な文字数制限を設定する。
  - 根本的な対策とはならない。
  - 攻撃のために必要な手数が増えると、攻撃者はより簡単に攻撃できるサイトへ移動する場合がある。
5. データベースのカラム定義にて、許容する文字数を必要な分だけに制限する。
  - [フルネーム] に許容された文字数が多すぎた。
  - これを回避するだけでもパスワードは漏洩しなかった。
6. SQL でキーとなりうる情報をそのまま画面には出さないようにする。
  - 今回の場合は、ユーザー名が該当する。
  - ランダムな ID などを別途発行し、キーとしたほうがすこしマシ。
7. ログイン試行のロックアウト機構を設ける。
  - ログインに一定回数失敗したら、そのユーザーでのログインを一定時間ブロックするもの。
  - 今回はログインするために使用するユーザーを問わなかったので、これだけでは解決しない。

これだけにはとどまらないかと思いますが、まずは基本的な部分をあげました。  
とくに、(1) (2) (3) は絶対に対策しておくようにしてください。  
これらを対策しておくだけでも、かなりの不正を防止することができます。

かんたんですが、以上にて。
